use std::{
    env,
    fs,
    str
};

fn main()
{
    env::args().skip(1).for_each(|arg| {
        match fs::read(&arg)
        {
            Ok(data) => match str::from_utf8(&data)
            {
                Ok(text) => match fs::write(&arg, generate_ast(text))
                {
                    Ok(()) => {},
                    Err(err) => println!("Error writing {arg}: {err}")
                },
                Err(err) => println!("Error reading {arg}: {err}")
            },
            Err(err) => println!("Error reading {arg}: {err}")
        }
    });
}

fn generate_ast(mut slice: &str) -> String
{
    const GEN_MARKER: &str = "\n// autogenerated code\n";
    const TYPE_CODE: &str = "\nstruct TYPE\n{\n\tARGSN\n}\n";

    if let Some(index) = slice.find(GEN_MARKER)
    { slice = &slice[..index]; }
    let mut text: String = slice.to_string();
    text.push_str(GEN_MARKER);

    let expr_types = Vec::from([
        ("Binary", "left: Box<dyn Expr>, oper: TokenType, right: Box<dyn Expr>"),
        ("Grouping", "expr: Box<dyn Expr>"),
        ("Literal", "value: LoxValue"),
        ("Unary", "oper: TokenType, expr: Box<dyn Expr>")
    ]);
    expr_types.iter().for_each(|tuple| {
        let (kind, args) = tuple;
        text.push_str(&TYPE_CODE.to_string()
            .replace("TYPE", kind)
            .replace("ARGSN", &args.to_string()
                .replace(", ", ",\n\t"))
            .replace("ARGS", args));
    });

    text
}
