use std::{
    env,
    fs,
    str
};

fn main()
{
    env::args().skip(1).for_each(|arg| {
        match fs::read(&arg)
        {
            Ok(data) => match str::from_utf8(&data)
            {
                Ok(text) => match fs::write(&arg, generate_ast(text))
                {
                    Ok(()) => {},
                    Err(err) => println!("Error writing {arg}: {err}")
                },
                Err(err) => println!("Error reading {arg}: {err}")
            },
            Err(err) => println!("Error reading {arg}: {err}")
        }
    });
}

fn generate_ast(mut slice: &str) -> String
{
    const MAIN_TYPE: &str = "Expr";
    const GEN_MARKER: &str = "\n// autogenerated code\n";
    const TYPE_CODE: &str = "\npub struct TYPE\n{\n\tpub ARGSN\n}\n";
    const MAIN_TRAIT: &str = "\npub trait MAIN\n{\nMETHODS}\n";
    const MAIN_VISIT: &str = "\tfn VERB(&self, visitor: &TYPE) -> RETURNS;\n";
    const MAIN_VISIT_BODY: &str = "\n\t{ visitor.visit_TYPEL(self) }";
    const VISIT_TRAIT: &str = "\ntrait Visitor<I>\n{\nMETHODS}\n";
    const VISIT_METHOD: &str = "\tfn visit_TYPEL(&self, expr: &TYPE) -> I;\n";
    const VISIT_CODE: &str = "\nimpl MAIN for TYPE\n{\nMETHODS}\n";

    if let Some(index) = slice.find(GEN_MARKER)
    { slice = &slice[..index]; }
    let mut text: String = slice.to_string();
    let mut pos = 0;
    let mut visitors: Vec<(&str, &str, &str)> = Vec::new();
    while pos < slice.len()
    {
        // TODO: merge if let chaining becomes stable
        if let Some(index) = slice[pos..]
            .find("// impl Visitor<").map(|i| i + pos)
        {
            if let Some(post_type) = slice[index..]
                .find("> for").map(|i| i + index)
            {
                if let Some(post_struct) = slice[post_type..]
                    .find(':').map(|i| i + post_type)
                {
                    if let Some(end) = slice[post_struct..]
                        .find(';').map(|i| i + post_struct)
                    {
                        visitors.push((&slice[index + 16 .. post_type].trim(),
                            &slice[post_type + 5 .. post_struct].trim(),
                            &slice[post_struct + 1 .. end].trim()));
                        pos = index + 1;
                    }
                    else { break }
                }
                else { break }
            }
            else { break }
        }
        else { break }
    }
    text.push_str(GEN_MARKER);

    text.push_str(&MAIN_TRAIT.to_string()
        .replace("MAIN", MAIN_TYPE)
        .replace("METHODS", &visitors.iter().map(|tuple| {
            let (returns, kind, verb) = tuple;
            MAIN_VISIT.to_string()
                .replace("VERB", verb)
                .replace("TYPE", kind)
                .replace("RETURNS", returns)
        }).collect::<Vec<String>>().join("")));
    let expr_types = Vec::from([
        ("Binary", "left: Box<dyn Expr>, oper: TokenType, right: Box<dyn Expr>"),
        ("Grouping", "expr: Box<dyn Expr>"),
        ("Literal", "value: LoxValue"),
        ("Unary", "oper: TokenType, expr: Box<dyn Expr>")
    ]);
    let visit_methods = if visitors.len() != 0
    {
        text.push_str(&VISIT_TRAIT.to_string()
            .replace("METHODS", &expr_types.iter().map(|tuple| {
                let (kind, _) = tuple;
                let kindl = &kind.to_lowercase();
                VISIT_METHOD.to_string()
                    .replace("TYPEL", kindl)
                    .replace("TYPE", kind)
            }).collect::<Vec<String>>().join("")));
        visitors.iter().map(|tuple| {
            let (returns, kind, verb) = tuple;
            MAIN_VISIT.to_string()
                .replace("VERB", verb)
                .replace("TYPE", kind)
                .replace("RETURNS", returns)
                .replace(";", MAIN_VISIT_BODY)
        }).collect::<Vec<String>>().join("")
    } else { "".to_string() };
    expr_types.iter().for_each(|tuple| {
        let (kind, args) = tuple;
        let kindl = &kind.to_lowercase();
        text.push_str(&TYPE_CODE.to_string()
            .replace("TYPE", kind)
            .replace("ARGSN", &args.to_string()
                .replace(", ", ",\n\tpub "))
            .replace("ARGS", &args));
        if visitors.len() != 0
        {
            text.push_str(&VISIT_CODE.to_string()
                .replace("MAIN", MAIN_TYPE)
                .replace("METHODS", &visit_methods)
                .replace("TYPEL", kindl)
                .replace("TYPE", kind));
        }
    });

    text
}
